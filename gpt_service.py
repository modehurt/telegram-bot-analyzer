import asyncio
import json
import re
from openai import OpenAI
from config import OPENAI_API_KEY
from data_analyzer import data_analyzer

client = OpenAI(api_key=OPENAI_API_KEY)

class GPTService:
    def __init__(self):
        self.client = client
    
    def validate_input(self, text: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–≤–æ–¥ –æ—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º"""
        if not text or len(text.strip()) < 3:
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        if re.match(r'^[^\w\s]+$', text.strip()):
            return False
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–∏–º–≤–æ–ª—ã
        if len(set(text.strip())) < 3:
            return False
        
        return True
    
    async def generate_post_idea(self, category: str, additional_info: str = "") -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–¥–µ—é –ø–æ—Å—Ç–∞ –¥–ª—è –∑–∞–¥–∞–Ω–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ë–î –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
            trending_data = await data_analyzer.get_trending_topics(category, days=7)
            popular_posts = await data_analyzer.get_popular_posts_by_category(category, limit=5)
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
            context = ""
            if trending_data:
                context += f"\n–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã –≤ —Ç–µ–º–µ '{category}':\n"
                for trend in trending_data[:3]:
                    context += f"‚Ä¢ {trend.get('topic', '–ù/–î')} - {trend.get('posts_count', 0)} –ø–æ—Å—Ç–æ–≤\n"
            
            if popular_posts:
                context += f"\n–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤ —Ç–µ–º–µ '{category}':\n"
                formats = {}
                for post in popular_posts:
                    fmt = post.get('format', 'unknown')
                    formats[fmt] = formats.get(fmt, 0) + 1
                for fmt, count in sorted(formats.items(), key=lambda x: x[1], reverse=True)[:3]:
                    context += f"‚Ä¢ {fmt} - {count} –ø–æ—Å—Ç–æ–≤\n"
            
            prompt = f"""–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –∏–¥–µ—é –¥–ª—è –ø–æ—Å—Ç–∞ –≤ Telegram-–∫–∞–Ω–∞–ª–µ –Ω–∞ —Ç–µ–º—É: ¬´{category}¬ª.

–ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ç–µ–º–∞, –Ω–æ –∏–∑ –Ω–µ–µ –º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∏—à—É (—Ñ–∏–Ω–∞–Ω—Å—ã, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Ç.–ø.), —É–∫–∞–∂–∏ –µ–µ.

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–î–∞–π:
‚Ä¢ –ö—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫
‚Ä¢ –û—Å–Ω–æ–≤–Ω—É—é –º—ã—Å–ª—å –ø–æ—Å—Ç–∞
‚Ä¢ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç (—Å—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥, —Å–ø–∏—Å–æ–∫, —Ñ–∞–∫—Ç/–≤–æ–ø—Ä–æ—Å, –∏ —Ç.–ø.)
‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ –ø–æ–¥–∞—á–µ (—Ç–æ–Ω, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤)

–û—Ç–≤–µ—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
  –ò–¥–µ—è: ...
  –°—É—Ç—å: ...
  –§–æ—Ä–º–∞—Ç: ...
  –°–æ–≤–µ—Ç—ã: ..."""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=500,
                temperature=0.7
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–∏: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    
    async def generate_post_idea_pro(self, category: str, user_id: int) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏–¥–µ—é –ø–æ—Å—Ç–∞ –¥–ª—è PRO –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∞–Ω–∞–ª–∏–∑–æ–º –∫–∞–Ω–∞–ª–∞"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∫–∞–Ω–∞–ª–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            user_channels = await data_analyzer.get_user_channels(user_id)
            channel_data = []
            
            if user_channels:
                for channel in user_channels[:3]:  # –ë–µ—Ä–µ–º –ø–µ—Ä–≤—ã–µ 3 –∫–∞–Ω–∞–ª–∞
                    posts = await data_analyzer.get_channel_posts(channel['channel_id'], limit=5)
                    if posts:
                        channel_data.append({
                            'title': channel.get('title', '–ù/–î'),
                            'description': channel.get('description', ''),
                            'posts': posts
                        })
            
            # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            context = ""
            if channel_data:
                context += "\n\n**–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–∏—Ö –∫–∞–Ω–∞–ª–∞—Ö:**\n"
                for i, channel in enumerate(channel_data, 1):
                    context += f"\n{i}. **{channel['title']}**\n"
                    if channel['description']:
                        context += f"–û–ø–∏—Å–∞–Ω–∏–µ: {channel['description']}\n"
                    
                    # –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –ª—É—á—à–∏–µ –ø–æ—Å—Ç—ã
                    top_posts = sorted(channel['posts'], key=lambda x: x.get('views', 0), reverse=True)[:2]
                    if top_posts:
                        context += "–õ—É—á—à–∏–µ –ø–æ—Å—Ç—ã:\n"
                        for post in top_posts:
                            views = post.get('views', 0)
                            text = post.get('text', '')[:100] + "..." if len(post.get('text', '')) > 100 else post.get('text', '')
                            er = post.get('er', 0)
                            context += f"‚Ä¢ {text} (–ø—Ä–æ—Å–º–æ—Ç—Ä—ã: {views}, ER: {er:.2f}%)\n"
            
            # –ü–æ–ª—É—á–∞–µ–º —Ç—Ä–µ–Ω–¥—ã –∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ—Å—Ç—ã
            trending_data = await data_analyzer.get_trending_topics(category, days=7)
            popular_posts = await data_analyzer.get_popular_posts_by_category(category, limit=5)
            
            if trending_data:
                context += f"\n\n**–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã –≤ —Ç–µ–º–µ '{category}':**\n"
                for trend in trending_data[:3]:
                    context += f"‚Ä¢ {trend.get('topic', '–ù/–î')} - {trend.get('posts_count', 0)} –ø–æ—Å—Ç–æ–≤\n"
            
            if popular_posts:
                context += f"\n**–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤ —Ç–µ–º–µ '{category}':**\n"
                formats = {}
                for post in popular_posts:
                    fmt = post.get('format', 'unknown')
                    formats[fmt] = formats.get(fmt, 0) + 1
                for fmt, count in sorted(formats.items(), key=lambda x: x[1], reverse=True)[:3]:
                    context += f"‚Ä¢ {fmt} - {count} –ø–æ—Å—Ç–æ–≤\n"
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è Telegram-–∫–∞–Ω–∞–ª–æ–≤. –°–æ–∑–¥–∞–π –∏–¥–µ—é –¥–ª—è –ø–æ—Å—Ç–∞ –Ω–∞ —Ç–µ–º—É: ¬´{category}¬ª.

{context}

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –æ—Ç–≤–µ—Ç—É:**
1. –£—á–∏—Ç—ã–≤–∞–π —Å—Ç–∏–ª—å –∏ —Ñ–æ—Ä–º–∞—Ç –ø–æ—Å—Ç–æ–≤ –∏–∑ –∫–∞–Ω–∞–ª–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
2. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–µ–Ω–¥—ã –∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤ —Ç–µ–º–µ
3. –ü—Ä–µ–¥–ª–æ–∂–∏ —É–Ω–∏–∫–∞–ª—å–Ω—É—é –∏–¥–µ—é, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –≤—ã–¥–µ–ª—è—Ç—å—Å—è

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞:**
**–ò–¥–µ—è:** [–ö—Ä–∞—Ç–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫]
**–°—É—Ç—å:** [–û—Å–Ω–æ–≤–Ω–∞—è –º—ã—Å–ª—å –ø–æ—Å—Ç–∞]
**–§–æ—Ä–º–∞—Ç:** [–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç: —Å—Ç–æ—Ä–∏—Ç–µ–ª–ª–∏–Ω–≥, —Å–ø–∏—Å–æ–∫, —Ñ–∞–∫—Ç/–≤–æ–ø—Ä–æ—Å, –∏ —Ç.–ø.]
**–°–æ–≤–µ—Ç—ã:** [–°–æ–≤–µ—Ç—ã –ø–æ –ø–æ–¥–∞—á–µ: —Ç–æ–Ω, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤]
**–ü–æ—á–µ–º—É —Å—Ä–∞–±–æ—Ç–∞–µ—Ç:** [–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –¥–∞–Ω–Ω—ã—Ö]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=800,
                temperature=0.8
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ PRO –∏–¥–µ–∏: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    
    async def analyze_popular_posts(self, category: str, posts_data: list) -> str:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ—Å—Ç—ã –∏ –¥–∞–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏"""
        if not posts_data:
            return "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤."
        
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è GPT –≤ —Ñ–æ—Ä–º–∞—Ç–µ –¢–ó
            top_posts = sorted(posts_data, key=lambda x: x.get('views', 0), reverse=True)[:5]
            posts_json = []
            
            for post in top_posts:
                views = post.get('views', 0)
                text = post.get('text', '')[:100] + "..." if len(post.get('text', '')) > 100 else post.get('text', '')
                er = post.get('er', 0)
                format_type = post.get('format', 'unknown')
                
                posts_json.append({
                    "title": text[:50] + "..." if len(text) > 50 else text,
                    "description": f"–ü–æ—Å—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ {format_type}",
                    "views": views,
                    "ER": f"{er:.1f}%",
                    "category": category.lower()
                })
            
            posts_str = ",\n".join([json.dumps(post, ensure_ascii=False) for post in posts_json])
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –≤ Telegram. –£ —Ç–µ–±—è –µ—Å—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –∏–∑ –∫–∞–Ω–∞–ª–æ–≤ –Ω–∞ —Ç–µ–º—É {category}.
–ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ï—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ç–µ–º–∞, –Ω–æ –∏–∑ –Ω–µ–µ –º–æ–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∏—à—É (—Ñ–∏–Ω–∞–Ω—Å—ã, –ø—Å–∏—Ö–æ–ª–æ–≥–∏—è –∏ —Ç.–ø.), —É–∫–∞–∂–∏ –µ–µ.

–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Ö –∏ –æ—Ñ–æ—Ä–º–∏ –ø–æ–¥–±–æ—Ä–∫—É –ª—É—á—à–∏—Ö –ø–æ—Å—Ç–æ–≤ –∫—Ä–∞—Å–∏–≤–æ –∏ –ø–æ–Ω—è—Ç–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
Telegram-–±–æ—Ç–∞.

–°—Ñ–æ—Ä–º–∏—Ä—É–π:
‚Ä¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç–∞
‚Ä¢ –£–∫–∞–∂–∏ —Ç–µ–º—É –∏ —É—Ä–æ–≤–µ–Ω—å –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ (ER)
‚Ä¢ –í –∫–æ–Ω—Ü–µ ‚Äî —Å–¥–µ–ª–∞–π –≤—ã–≤–æ–¥: —á—Ç–æ –æ–±—â–µ–≥–æ –º–µ–∂–¥—É —ç—Ç–∏–º–∏ –ø–æ—Å—Ç–∞–º–∏ –∏ –∫–∞–∫–æ–π —Ñ–æ—Ä–º–∞—Ç —Å–µ–π—á–∞—Å —Ä–∞–±–æ—Ç–∞–µ—Ç

–í–æ—Ç —Å–ø–∏—Å–æ–∫ –ø–æ—Å—Ç–æ–≤:
{posts_str}"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=800,
                temperature=0.7
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å—Ç–æ–≤: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    
    async def suggest_post_format(self, format_type: str, topic: str = "") -> str:
        """–ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Ñ–æ—Ä–º–∞—Ç –ø–æ—Å—Ç–∞"""
        try:
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –ø—Ä–∏–º–µ—Ä—ã –ø–æ—Å—Ç–æ–≤ –≤ —ç—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
            examples = await data_analyzer.get_popular_posts_by_category(topic if topic else "–û–±—â–∏–µ", limit=10)
            format_examples = [p for p in examples if p.get('format') == format_type][:3]
            
            context = ""
            if format_examples:
                context += f"\n–ü—Ä–∏–º–µ—Ä—ã —É—Å–ø–µ—à–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤ –≤ —Ñ–æ—Ä–º–∞—Ç–µ '{format_type}':\n"
                for i, example in enumerate(format_examples, 1):
                    text = example.get('text', '')[:100] + "..." if len(example.get('text', '')) > 100 else example.get('text', '')
                    views = example.get('views', 0)
                    context += f"{i}. {views:,} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ | {text}\n"
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—é Telegram-–∫–∞–Ω–∞–ª–æ–≤. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –ø–æ–ª—É—á–∏—Ç—å —Å–æ–≤–µ—Ç—ã –ø–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ø–æ—Å—Ç–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ "{format_type}".

–ï—Å–ª–∏ —Ñ–æ—Ä–º–∞—Ç –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_formats": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–û–±—ä—è—Å–Ω–∏:
‚Ä¢ –ß—Ç–æ —Ç–∞–∫–æ–µ —Ñ–æ—Ä–º–∞—Ç "{format_type}"
‚Ä¢ –ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç –≤ —ç—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
‚Ä¢ –ö–∞–∫–∏–µ —ç–ª–µ–º–µ–Ω—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
‚Ä¢ –°–æ–≤–µ—Ç—ã –ø–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—é
‚Ä¢ –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

–û—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –∏ –ø—Ä–∞–∫—Ç–∏—á–Ω—ã–º."""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=600,
                temperature=0.7
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–∞: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    
    async def analyze_post_feedback(self, post_text: str, category: str = "") -> str:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–∞–µ—Ç –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å"""
        try:
            if not self.validate_input(post_text):
                return "‚ùå –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞."
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
            context = ""
            if category:
                popular_posts = await data_analyzer.get_popular_posts_by_category(category, limit=3)
                if popular_posts:
                    context += f"\n–î–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è, –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ –ø–æ—Å—Ç—ã –≤ —Ç–µ–º–µ '{category}':\n"
                    for i, post in enumerate(popular_posts, 1):
                        text = post.get('text', '')[:50] + "..." if len(post.get('text', '')) > 50 else post.get('text', '')
                        context += f"{i}. {text}\n"
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –≤ Telegram. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –¥–∞–π –¥–µ—Ç–∞–ª—å–Ω—É—é –æ–±—Ä–∞—Ç–Ω—É—é —Å–≤—è–∑—å.

–ü–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:
{post_text}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è:{context}

–ü—Ä–æ–≤–µ–¥–∏ –∞–Ω–∞–ª–∏–∑ –ø–æ –∫—Ä–∏—Ç–µ—Ä–∏—è–º:
1. –ó–∞–≥–æ–ª–æ–≤–æ–∫ (—Ü–µ–ø–ª—è–µ—Ç –ª–∏ –≤–Ω–∏–º–∞–Ω–∏–µ)
2. –û—Å–Ω–æ–≤–Ω–∞—è –º—ã—Å–ª—å (–ø–æ–Ω—è—Ç–Ω–∞ –ª–∏)
3. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ª–æ–≥–∏–∫–∞
4. –≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –≤–æ–∑–¥–µ–π—Å—Ç–≤–∏–µ
5. –ü—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é
6. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∞—Å–ø–µ–∫—Ç—ã

–î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—Ä–∏—Ç–µ—Ä–∏—è –¥–∞–π:
‚Ä¢ –û—Ü–µ–Ω–∫—É (1-10)
‚Ä¢ –ß—Ç–æ —Ö–æ—Ä–æ—à–æ
‚Ä¢ –ß—Ç–æ –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å
‚Ä¢ –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

–í –∫–æ–Ω—Ü–µ –¥–∞–π –æ–±—â—É—é –æ—Ü–µ–Ω–∫—É –∏ 3 –≥–ª–∞–≤–Ω—ã—Ö —Å–æ–≤–µ—Ç–∞ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è."""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=1000,
                temperature=0.7
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–æ—Å—Ç–∞: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    
    async def rewrite_post(self, post_text: str, style: str = "improved", category: str = "") -> str:
        """–£–ª—É—á—à–∞–µ—Ç –ø–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
        try:
            if not self.validate_input(post_text):
                return "‚ùå –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞."
            
            # –ü–æ–ª—É—á–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –ë–î
            context = ""
            if category:
                popular_posts = await data_analyzer.get_popular_posts_by_category(category, limit=2)
                if popular_posts:
                    context += f"\n–£—á–∏—Ç—ã–≤–∞—è —É—Å–ø–µ—à–Ω—ã–µ –ø–æ—Å—Ç—ã –≤ —Ç–µ–º–µ '{category}':\n"
                    for post in popular_posts:
                        text = post.get('text', '')[:100] + "..." if len(post.get('text', '')) > 100 else post.get('text', '')
                        context += f"‚Ä¢ {text}\n"
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∫–æ–Ω—Ç–µ–Ω—Ç—É –≤ Telegram. –£–ª—É—á—à–∏ –ø–æ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Å–¥–µ–ª–∞–≤ –µ–≥–æ –±–æ–ª–µ–µ –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–º –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–º.

–û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –ø–æ—Å—Ç:
{post_text}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è:{context}

–°–æ–∑–¥–∞–π —É–ª—É—á—à–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é —Å:
‚Ä¢ –ë–æ–ª–µ–µ —Ü–µ–ø–ª—è—é—â–∏–º –∑–∞–≥–æ–ª–æ–≤–∫–æ–º
‚Ä¢ –õ—É—á—à–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
‚Ä¢ –£—Å–∏–ª–µ–Ω–Ω—ã–º –ø—Ä–∏–∑—ã–≤–æ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é
‚Ä¢ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —ç–º–æ–¥–∑–∏ –≥–¥–µ —É–º–µ—Å—Ç–Ω–æ
‚Ä¢ –ü–æ–≤—ã—à–µ–Ω–∏–µ–º —ç–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
‚Ä¢ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –º—ã—Å–ª–∏

–ü—Ä–µ–¥—Å—Ç–∞–≤—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
üìù –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø:

[—É–ª—É—á—à–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç]

üîß –ß–¢–û –ò–ó–ú–ï–ù–ï–ù–û:
‚Ä¢ [—Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω–µ–Ω–∏–π]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=800,
                temperature=0.8
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ —É–ª—É—á—à–µ–Ω–∏—è –ø–æ—Å—Ç–∞: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    
    async def generate_ad_ideas(self, category: str, product_info: str = "") -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∏–¥–µ–∏"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫—Ä–µ–∞—Ç–∏–≤–∞—Ö
            creatives = await data_analyzer.get_successful_creatives_by_category(category, limit=5)
            
            context = ""
            if creatives:
                context += f"\n–£—Å–ø–µ—à–Ω—ã–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∫—Ä–µ–∞—Ç–∏–≤—ã –≤ —Ç–µ–º–µ '{category}':\n"
                for i, creative in enumerate(creatives, 1):
                    title = creative.get('ad_title', '')[:50] + "..." if len(creative.get('ad_title', '')) > 50 else creative.get('ad_title', '')
                    context += f"{i}. {title}\n"
            
            prompt = f"""–¢—ã ‚Äî –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –¥–ª—è Telegram Ads. –°–æ–∑–¥–∞–π 3 —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∏–¥–µ–∏ –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –≤ —Ç–µ–º–µ "{category}".

–ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–°–æ–∑–¥–∞–π 3 —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∏–¥–µ–∏:
1. –ö–ï–ô–°-–ò–°–¢–û–†–ò–Ø - –∏—Å—Ç–æ—Ä–∏—è —É—Å–ø–µ—Ö–∞ –∫–ª–∏–µ–Ω—Ç–∞
2. –ü–†–û–ë–õ–ï–ú–ê-–†–ï–®–ï–ù–ò–ï - —Ä–µ—à–µ–Ω–∏–µ –±–æ–ª–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏  
3. –û–ë–ó–û–† –ò –õ–ò–ß–ù–´–ô –û–ü–´–¢ - –ª–∏—á–Ω—ã–π –æ–ø—ã—Ç —ç–∫—Å–ø–µ—Ä—Ç–∞

–î–ª—è –∫–∞–∂–¥–æ–π –∏–¥–µ–∏ —É–∫–∞–∂–∏:
‚Ä¢ –ó–∞–≥–æ–ª–æ–≤–æ–∫
‚Ä¢ –û—Å–Ω–æ–≤–Ω—É—é –º—ã—Å–ª—å
‚Ä¢ –ü—Ä–∏–º–µ—Ä —Ç–µ–∫—Å—Ç–∞
‚Ä¢ –¶–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é
‚Ä¢ –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç

–£—á–∏—Ç—ã–≤–∞–π –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ Telegram-–∞—É–¥–∏—Ç–æ—Ä–∏–∏ –∏ —Ç—Ä–µ–Ω–¥—ã –≤ —Ç–µ–º–µ."""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=800,
                temperature=0.8
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∏–¥–µ–π: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    
    async def generate_promo_text(self, category: str, product_info: str = "") -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–º–æ-—Ç–µ–∫—Å—Ç—ã –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–º–æ-—Ç–µ–∫—Å—Ç–∞—Ö
            promo_examples = await data_analyzer.get_successful_creatives_by_category(category, limit=3)
            
            context = ""
            if promo_examples:
                context += f"\n–£—Å–ø–µ—à–Ω—ã–µ –ø—Ä–æ–º–æ-—Ç–µ–∫—Å—Ç—ã –≤ —Ç–µ–º–µ '{category}':\n"
                for example in promo_examples:
                    text = example.get('ad_text', '')[:100] + "..." if len(example.get('ad_text', '')) > 100 else example.get('ad_text', '')
                    context += f"‚Ä¢ {text}\n"
            
            prompt = f"""–¢—ã ‚Äî –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫—Ä–µ–∞—Ç–∏–≤–æ–≤ –¥–ª—è Telegram Ads. –°–æ–∑–¥–∞–π –ø—Ä–æ–º–æ-—Ç–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –∫–∞–Ω–∞–ª–∞ –≤ —Ç–µ–º–µ "{category}".

–ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–°–æ–∑–¥–∞–π –ø—Ä–æ–º–æ-—Ç–µ–∫—Å—Ç –∫–æ—Ç–æ—Ä—ã–π:
‚Ä¢ –¶–µ–ø–ª—è–µ—Ç —Å –ø–µ—Ä–≤—ã—Ö —Å—Ç—Ä–æ–∫ (—Ö–æ—Ä–æ—à–∏–π "—Ö—É–∫")
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω (–∏–Ω—Ç—Ä–∏–≥–∞ ‚Üí —Ü–µ–Ω–Ω–æ—Å—Ç—å ‚Üí –ø—Ä–∏–∑—ã–≤)
‚Ä¢ –ü–æ–Ω—è—Ç–µ–Ω –∏ –∫—Ä–∞—Ç–æ–∫ (–¥–æ ~150 —Å–∏–º–≤–æ–ª–æ–≤)
‚Ä¢ –°–æ–¥–µ—Ä–∂–∏—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π call-to-action
‚Ä¢ –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è Telegram-–∞—É–¥–∏—Ç–æ—Ä–∏–∏

–ü—Ä–µ–¥—Å—Ç–∞–≤—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ñ–æ—Ä–º–∞—Ç–µ:
üì¢ –ü–†–û–ú–û-–¢–ï–ö–°–¢:

[—Ç–µ–∫—Å—Ç]

üéØ –¶–ï–õ–ï–í–ê–Ø –ê–£–î–ò–¢–û–†–ò–Ø: [–æ–ø–∏—Å–∞–Ω–∏–µ]
üí° –ö–õ–Æ–ß–ï–í–´–ï –ü–†–ï–ò–ú–£–©–ï–°–¢–í–ê: [—Å–ø–∏—Å–æ–∫]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=400,
                temperature=0.8
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–º–æ-—Ç–µ–∫—Å—Ç–∞: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    
    async def analyze_top_cta(self, category: str, posts_data: list) -> str:
        """–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ª—É—á—à–∏–µ CTA –ø–æ —Ç–µ–º–µ"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ò–∑–≤–ª–µ–∫–∞–µ–º CTA –∏–∑ –ø–æ—Å—Ç–æ–≤
            cta_examples = []
            for post in posts_data:
                cta = post.get('cta', '')
                if cta and len(cta.strip()) > 5:
                    views = post.get('views', 0)
                    cta_examples.append({
                        'cta': cta,
                        'views': views,
                        'er': post.get('er', 0)
                    })
            
            # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
            cta_examples.sort(key=lambda x: x['views'] * x['er'], reverse=True)
            
            context = ""
            if cta_examples:
                context += f"\n–õ—É—á—à–∏–µ CTA –≤ —Ç–µ–º–µ '{category}':\n"
                for i, cta in enumerate(cta_examples[:5], 1):
                    context += f"{i}. '{cta['cta']}' - {cta['views']:,} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, ER: {cta['er']:.1f}%\n"
            
            prompt = f"""–¢—ã ‚Äî –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä, —ç–∫—Å–ø–µ—Ä—Ç –≤ –Ω–∞–ø–∏—Å–∞–Ω–∏–∏ Call-to-Action –¥–ª—è –ø–æ—Å—Ç–æ–≤ –∏ —Ä–µ–∫–ª–∞–º—ã –≤ Telegram.
–ù–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–º—ã "{category}" –∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö, –ø–æ–¥–±–µ—Ä–∏ 7 –ª—É—á—à–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ CTA ‚Äî —Ñ—Ä–∞–∑, –∫–æ—Ç–æ—Ä—ã–µ:
‚Ä¢ –ö–æ—Ä–æ—Ç–∫–∏–µ –∏ —Ü–µ–ø–ª—è—é—â–∏–µ
‚Ä¢ –ü–æ–±—É–∂–¥–∞—é—Ç –∫ –¥–µ–π—Å—Ç–≤–∏—é (–ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è, –ø–µ—Ä–µ–π—Ç–∏, –Ω–∞–ø–∏—Å–∞—Ç—å, –ø—Ä–æ–≥–æ–ª–æ—Å–æ–≤–∞—Ç—å –∏ —Ç.–ø.)
‚Ä¢ –ü–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤ –∫–æ–Ω—Ü–µ –ø–æ—Å—Ç–∞, –≤ –∫–Ω–æ–ø–∫–µ, –∏–ª–∏ –≤ —Ä–µ–∫–ª–∞–º–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏

–ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π 7 –ª—É—á—à–∏—Ö CTA –¥–ª—è —Ç–µ–º—ã "{category}" –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üî• –¢–û–ü-7 CTA –î–õ–Ø –¢–ï–ú–´ "{category.upper()}":

1. [CTA –≤–∞—Ä–∏–∞–Ω—Ç]
2. [CTA –≤–∞—Ä–∏–∞–Ω—Ç]
...
7. [CTA –≤–∞—Ä–∏–∞–Ω—Ç]

üí° –°–û–í–ï–¢–´ –ü–û –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Æ:
‚Ä¢ [—Å–æ–≤–µ—Ç—ã –ø–æ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=500,
                temperature=0.7
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ CTA: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    
    async def generate_trending_topics(self, category: str) -> str:
        """–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–Ω–¥–æ–≤—ã—Ö —Ç–µ–º"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ —Ç—Ä–µ–Ω–¥–∞—Ö
            trending_data = await data_analyzer.get_trending_topics(category, days=7)
            
            if not trending_data:
                return f"üìà –¢–†–ï–ù–î–û–í–´–ï –¢–ï–ú–´\n\n–ö–∞—Ç–µ–≥–æ—Ä–∏—è: {category}\n\n‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n‚Ä¢ –î—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é\n‚Ä¢ –ë–æ–ª–µ–µ —à–∏—Ä–æ–∫–∏–π –ø–µ—Ä–∏–æ–¥\n‚Ä¢ –î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –∫–∞–Ω–∞–ª–æ–≤ –≤ –±–∞–∑—É"
            
            # –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è GPT
            trends_summary = []
            for trend in trending_data[:5]:
                trends_summary.append({
                    'topic': trend.get('topic', '–ù/–î'),
                    'posts_count': trend.get('posts_count', 0),
                    'total_views': trend.get('total_views', 0),
                    'avg_er': trend.get('avg_er', 0),
                    'ad_percentage': trend.get('ad_percentage', 0)
                })
            
            trends_str = "\n".join([
                f"‚Ä¢ {t['topic']} - {t['posts_count']} –ø–æ—Å—Ç–æ–≤, {t['total_views']:,} –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤, ER: {t['avg_er']:.1f}%"
                for t in trends_summary
            ])
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É —Ç—Ä–µ–Ω–¥–æ–≤ –≤ Telegram. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–µ–Ω–¥–æ–≤—ã–µ —Ç–µ–º—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{category}" –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π.

–ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–î–∞–Ω–Ω—ã–µ –æ —Ç—Ä–µ–Ω–¥–∞—Ö:
{trends_str}

–°–æ–∑–¥–∞–π –∞–Ω–∞–ª–∏–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üìà –¢–†–ï–ù–î–û–í–´–ï –¢–ï–ú–´ –í –ö–ê–¢–ï–ì–û–†–ò–ò "{category.upper()}"

üî• –¢–û–ü-5 –¢–†–ï–ù–î–û–í:
[–ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∫–∞–∂–¥–æ–≥–æ —Ç—Ä–µ–Ω–¥–∞]

üìä –°–¢–ê–¢–ò–°–¢–ò–ö–ê:
‚Ä¢ –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ—Å—Ç–æ–≤: [—á–∏—Å–ª–æ]
‚Ä¢ –°—Ä–µ–¥–Ω–∏–π ER: [—á–∏—Å–ª–æ]%
‚Ä¢ –ü—Ä–æ—Ü–µ–Ω—Ç —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –ø–æ—Å—Ç–æ–≤: [—á–∏—Å–ª–æ]%

üí° –í–´–í–û–î–´:
‚Ä¢ [–æ—Å–Ω–æ–≤–Ω—ã–µ –≤—ã–≤–æ–¥—ã –æ —Ç—Ä–µ–Ω–¥–∞—Ö]
‚Ä¢ [—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–Ω—Ç-–º–µ–π–∫–µ—Ä–æ–≤]
‚Ä¢ [–ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=700,
                temperature=0.7
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."
    
    async def suggest_engagement_boost(self, category: str, current_engagement: str = "") -> str:
        """–ü—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –∏–¥–µ–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ –∏–∑ –ë–î
            engagement_data = await data_analyzer.get_engagement_analysis(category)
            
            context = ""
            if engagement_data:
                avg_er = engagement_data.get('avg_er', 0)
                best_formats = engagement_data.get('best_formats', [])
                context += f"\n–¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Ç–µ–º–µ '{category}':\n"
                context += f"‚Ä¢ –°—Ä–µ–¥–Ω–∏–π ER: {avg_er:.1f}%\n"
                if best_formats:
                    context += f"‚Ä¢ –õ—É—á—à–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã: {', '.join(best_formats[:3])}\n"
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –ø–æ–≤—ã—à–µ–Ω–∏—é –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ –≤ Telegram-–∫–∞–Ω–∞–ª–∞—Ö. –ü—Ä–µ–¥–ª–æ–∂–∏ –∏–¥–µ–∏ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Ç–µ–º–µ "{category}".

–ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–°–æ–∑–¥–∞–π –ø–ª–∞–Ω –ø–æ–≤—ã—à–µ–Ω–∏—è –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üöÄ –ò–î–ï–ò –î–õ–Ø –ü–û–í–´–®–ï–ù–ò–Ø –í–û–í–õ–ï–ß–ï–ù–ù–û–°–¢–ò

üìù –ö–û–ù–¢–ï–ù–¢–ù–´–ï –°–¢–†–ê–¢–ï–ì–ò–ò:
‚Ä¢ [3-4 –∏–¥–µ–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é –∫–æ–Ω—Ç–µ–Ω—Ç–∞]

üéØ –ò–ù–¢–ï–†–ê–ö–¢–ò–í–ù–´–ï –≠–õ–ï–ú–ï–ù–¢–´:
‚Ä¢ [3-4 –∏–¥–µ–∏ –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –∞—É–¥–∏—Ç–æ—Ä–∏–µ–π]

‚è∞ –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –ü–†–ò–ï–ú–´:
‚Ä¢ [3-4 —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–µ–º–∞]

üìä –ò–ó–ú–ï–†–ï–ù–ò–ï –†–ï–ó–£–õ–¨–¢–ê–¢–û–í:
‚Ä¢ [–º–µ—Ç—Ä–∏–∫–∏ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=600,
                temperature=0.8
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∏–¥–µ–π –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç–∏: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."

    # --- V2 –ú–ï–¢–û–î–´ ---
    async def generate_ad_tips(self, category: str) -> str:
        """V2: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å–æ–≤–µ—Ç—ã –ø–æ —Ä–µ–∫–ª–∞–º–µ"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ä–µ–∫–ª–∞–º–Ω—ã—Ö –∫—Ä–µ–∞—Ç–∏–≤–∞—Ö
            creatives = await data_analyzer.get_successful_creatives_by_category(category, limit=5)
            
            context = ""
            if creatives:
                context += f"\n–£—Å–ø–µ—à–Ω—ã–µ —Ä–µ–∫–ª–∞–º–Ω—ã–µ –∫—Ä–µ–∞—Ç–∏–≤—ã –≤ —Ç–µ–º–µ '{category}':\n"
                for i, creative in enumerate(creatives, 1):
                    title = creative.get('ad_title', '')[:50] + "..." if len(creative.get('ad_title', '')) > 50 else creative.get('ad_title', '')
                    context += f"{i}. {title}\n"
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ä–µ–∫–ª–∞–º–µ –≤ Telegram. –°–æ–∑–¥–∞–π –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–≤–µ—Ç—ã –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π —Ä–µ–∫–ª–∞–º—ã –¥–ª—è —Ç–µ–º—ã "{category}".

–ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–°–æ–∑–¥–∞–π —Å–æ–≤–µ—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üí° –°–û–í–ï–¢–´ –ü–û –†–ï–ö–õ–ê–ú–ï (V2)

üéØ –¶–ï–õ–ï–í–ê–Ø –ê–£–î–ò–¢–û–†–ò–Ø:
‚Ä¢ [–æ–ø–∏—Å–∞–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏]

üìù –°–¢–†–£–ö–¢–£–†–ê –†–ï–ö–õ–ê–ú–ù–û–ì–û –ü–û–°–¢–ê:
‚Ä¢ [—ç–ª–µ–º–µ–Ω—Ç—ã —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ —Ä–µ–∫–ª–∞–º–Ω–æ–≥–æ –ø–æ—Å—Ç–∞]

üî• –ü–†–ò–ï–ú–´ –ü–†–ò–í–õ–ï–ß–ï–ù–ò–Ø –í–ù–ò–ú–ê–ù–ò–Ø:
‚Ä¢ [3-4 –ø—Ä–∏–µ–º–∞ –¥–ª—è —Ü–µ–ø–ª—è—é—â–∏—Ö –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤]

üí¨ –ü–†–ò–ó–´–í–´ –ö –î–ï–ô–°–¢–í–ò–Æ:
‚Ä¢ [—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–µ CTA –¥–ª—è —Ç–µ–º—ã]

‚ö†Ô∏è –ß–ê–°–¢–´–ï –û–®–ò–ë–ö–ò:
‚Ä¢ [—á—Ç–æ –∏–∑–±–µ–≥–∞—Ç—å –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ä–µ–∫–ª–∞–º—ã]

‚úÖ –õ–£–ß–®–ò–ï –ü–†–ê–ö–¢–ò–ö–ò:
‚Ä¢ [–ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=700,
                temperature=0.7
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ–≤–µ—Ç–æ–≤ –ø–æ —Ä–µ–∫–ª–∞–º–µ: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."

    async def generate_promo_plan(self, category: str) -> str:
        """V2: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –ø–ª–∞–Ω –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç—Ä–µ–Ω–¥–∞—Ö
            trending_data = await data_analyzer.get_trending_topics(category, days=7)
            
            context = ""
            if trending_data:
                context += f"\n–ê–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã –≤ —Ç–µ–º–µ '{category}':\n"
                for trend in trending_data[:3]:
                    context += f"‚Ä¢ {trend.get('topic', '–ù/–î')} - {trend.get('posts_count', 0)} –ø–æ—Å—Ç–æ–≤\n"
            
            prompt = f"""–¢—ã ‚Äî –º–∞—Ä–∫–µ—Ç–æ–ª–æ–≥, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∏–π—Å—è –Ω–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏–∏ –≤ Telegram. –°–æ–∑–¥–∞–π –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –ø–ª–∞–Ω –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ–º—ã "{category}".

–ï—Å–ª–∏ —Ç–µ–º–∞ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–°–æ–∑–¥–∞–π –ø–ª–∞–Ω –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üìã –ü–õ–ê–ù –ü–†–û–î–í–ò–ñ–ï–ù–ò–Ø (V2)

üéØ –¶–ï–õ–ò –ò –ó–ê–î–ê–ß–ò:
‚Ä¢ [–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ü–µ–ª–∏ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è]

üìÖ –ö–ê–õ–ï–ù–î–ê–†–¨ –ü–†–û–î–í–ò–ñ–ï–ù–ò–Ø:
‚Ä¢ –ù–µ–¥–µ–ª—è 1: [–¥–µ–π—Å—Ç–≤–∏—è]
‚Ä¢ –ù–µ–¥–µ–ª—è 2: [–¥–µ–π—Å—Ç–≤–∏—è]
‚Ä¢ –ù–µ–¥–µ–ª—è 3: [–¥–µ–π—Å—Ç–≤–∏—è]
‚Ä¢ –ù–µ–¥–µ–ª—è 4: [–¥–µ–π—Å—Ç–≤–∏—è]

üí∞ –†–ï–ö–õ–ê–ú–ù–´–ô –ë–Æ–î–ñ–ï–¢:
‚Ä¢ [—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞]

üìä –ö–ê–ù–ê–õ–´ –ü–†–û–î–í–ò–ñ–ï–ù–ò–Ø:
‚Ä¢ [—Å–ø–∏—Å–æ–∫ –∫–∞–Ω–∞–ª–æ–≤ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–π]

üìà KPI –ò –ú–ï–¢–†–ò–ö–ò:
‚Ä¢ [–∫–ª—é—á–µ–≤—ã–µ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏]

üîÑ A/B –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï:
‚Ä¢ [–ø–ª–∞–Ω—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=800,
                temperature=0.7
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞–Ω–∞ –ø—Ä–æ–¥–≤–∏–∂–µ–Ω–∏—è: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Ç–µ–º—É –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."

    async def analyze_content_trends(self, category: str) -> str:
        """V2: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç—Ä–µ–Ω–¥—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç—Ä–µ–Ω–¥–∞—Ö –∫–æ–Ω—Ç–µ–Ω—Ç–∞
            content_data = await data_analyzer.analyze_content_trends(category)
            
            context = ""
            if content_data:
                formats = content_data.get('formats', [])
                if formats:
                    context += f"\n–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã –≤ —Ç–µ–º–µ '{category}':\n"
                    for fmt in formats[:3]:
                        context += f"‚Ä¢ {fmt.get('format', '–ù/–î')} - {fmt.get('count', 0)} –ø–æ—Å—Ç–æ–≤, ER: {fmt.get('avg_er', 0):.1f}%\n"
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –∫–æ–Ω—Ç–µ–Ω—Ç-—Ç—Ä–µ–Ω–¥–æ–≤ –≤ Telegram. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–µ–Ω–¥—ã –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{category}".

–ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–°–æ–∑–¥–∞–π –∞–Ω–∞–ª–∏–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üìà –¢–†–ï–ù–î–´ –ö–û–ù–¢–ï–ù–¢–ê (V2)

üî• –ü–û–ü–£–õ–Ø–†–ù–´–ï –§–û–†–ú–ê–¢–´:
‚Ä¢ [–∞–Ω–∞–ª–∏–∑ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤]

üì± –ù–û–í–´–ï –¢–†–ï–ù–î–´:
‚Ä¢ [–Ω–æ–≤—ã–µ –ø–æ–¥—Ö–æ–¥—ã –∫ –∫–æ–Ω—Ç–µ–Ω—Ç—É]

üí¨ –¢–ï–ú–´ –î–õ–Ø –û–ë–°–£–ñ–î–ï–ù–ò–Ø:
‚Ä¢ [–∞–∫—Ç—É–∞–ª—å–Ω—ã–µ —Ç–µ–º—ã]

üöÄ –ò–ù–ù–û–í–ê–¶–ò–û–ù–ù–´–ï –ü–û–î–•–û–î–´:
‚Ä¢ [–∫—Ä–µ–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è]

üîÆ –ü–†–û–ì–ù–û–ó–´:
‚Ä¢ [–ø—Ä–æ–≥–Ω–æ–∑—ã —Ä–∞–∑–≤–∏—Ç–∏—è —Ç—Ä–µ–Ω–¥–æ–≤]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=700,
                temperature=0.8
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤ –∫–æ–Ω—Ç–µ–Ω—Ç–∞: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."

    async def analyze_trend_detective(self, category: str) -> str:
        """V2: –¢—Ä–µ–Ω–¥-–¥–µ—Ç–µ–∫—Ç–∏–≤ –∞–Ω–∞–ª–∏–∑"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ—Ç–µ–∫—Ç–∏–≤–∞
            trending_data = await data_analyzer.get_trending_topics(category, days=7)
            falling_data = await data_analyzer.get_falling_trends(category)
            
            context = ""
            if trending_data:
                context += f"\n–¢–æ–ø-3 —Ç—Ä–µ–Ω–¥–∞ –≤ '{category}':\n"
                for trend in trending_data[:3]:
                    context += f"‚Ä¢ {trend.get('topic', '–ù/–î')} - {trend.get('posts_count', 0)} –ø–æ—Å—Ç–æ–≤\n"
            
            if falling_data:
                context += f"\n–ü–∞–¥–∞—é—â–∏–µ —Ç—Ä–µ–Ω–¥—ã –≤ '{category}':\n"
                for trend in falling_data[:2]:
                    context += f"‚Ä¢ {trend.get('format', '–ù/–î')} - —Å–ø–∞–¥ –Ω–∞ {trend.get('decline_percent', 0):.1f}%\n"
            
            prompt = f"""–¢—ã ‚Äî —Ç—Ä–µ–Ω–¥-–¥–µ—Ç–µ–∫—Ç–∏–≤, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –≤—ã—è–≤–ª–µ–Ω–∏—é —Å–∫—Ä—ã—Ç—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –≤ Telegram. –ü—Ä–æ–≤–µ–¥–∏ –¥–µ—Ç–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —Ç—Ä–µ–Ω–¥–æ–≤ –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{category}".

–ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–°–æ–∑–¥–∞–π –¥–µ—Ç–µ–∫—Ç–∏–≤–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üîç –¢–†–ï–ù–î-–î–ï–¢–ï–ö–¢–ò–í (V2)

üïµÔ∏è –°–ö–†–´–¢–´–ï –¢–†–ï–ù–î–´:
‚Ä¢ [–Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ —Ç—Ä–µ–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –æ–±–Ω–∞—Ä—É–∂–∏–ª–∏]

üîç –ü–†–ò–ó–ù–ê–ö–ò –†–û–°–¢–ê:
‚Ä¢ [—Å–∏–≥–Ω–∞–ª—ã —Ä–∞—Å—Ç—É—â–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤]

‚ö†Ô∏è –ü–†–ï–î–£–ü–†–ï–ñ–î–ê–Æ–©–ò–ï –°–ò–ì–ù–ê–õ–´:
‚Ä¢ [–ø—Ä–∏–∑–Ω–∞–∫–∏ –ø–∞–¥–∞—é—â–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤]

üí° –ò–ù–°–ê–ô–¢–´:
‚Ä¢ [–Ω–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–µ –≤—ã–≤–æ–¥—ã]

üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
‚Ä¢ [—á—Ç–æ –¥–µ–ª–∞—Ç—å —Å –ø–æ–ª—É—á–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=700,
                temperature=0.8
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ —Ç—Ä–µ–Ω–¥-–¥–µ—Ç–µ–∫—Ç–∏–≤–∞: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."

    async def analyze_falling_trends(self, category: str) -> str:
        """V2: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ø–∞–¥–∞—é—â–∏–µ —Ç—Ä–µ–Ω–¥—ã"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–∞–¥–∞—é—â–∏—Ö —Ç—Ä–µ–Ω–¥–∞—Ö
            falling_data = await data_analyzer.get_falling_trends(category)
            
            context = ""
            if falling_data:
                context += f"\n–ü–∞–¥–∞—é—â–∏–µ —Ç—Ä–µ–Ω–¥—ã –≤ '{category}':\n"
                for trend in falling_data[:3]:
                    context += f"‚Ä¢ {trend.get('format', '–ù/–î')} - —Å–ø–∞–¥ –Ω–∞ {trend.get('decline_percent', 0):.1f}%\n"
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É –ø–∞–¥–∞—é—â–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤ –≤ Telegram. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ø–∞–¥–∞—é—â–∏–µ —Ç—Ä–µ–Ω–¥—ã –¥–ª—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{category}".

–ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–°–æ–∑–¥–∞–π –∞–Ω–∞–ª–∏–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üìâ –ü–ê–î–ê–Æ–©–ò–ï –¢–†–ï–ù–î–´ (V2)

‚ùå –ß–¢–û –¢–ï–†–Ø–ï–¢ –ü–û–ü–£–õ–Ø–†–ù–û–°–¢–¨:
‚Ä¢ [—Å–ø–∏—Å–æ–∫ –ø–∞–¥–∞—é—â–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤]

üì± –£–°–¢–ê–†–ï–í–®–ò–ï –§–û–†–ú–ê–¢–´:
‚Ä¢ [—Ñ–æ—Ä–º–∞—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –±–æ–ª—å—à–µ –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç]

üí¨ –¢–ï–ú–´, –ö–û–¢–û–†–´–ï –ù–ï –†–ê–ë–û–¢–ê–Æ–¢:
‚Ä¢ [—Ç–µ–º—ã —Å –Ω–∏–∑–∫–æ–π –≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å—é]

üîç –ü–†–ò–ß–ò–ù–´ –ü–ê–î–ï–ù–ò–Ø:
‚Ä¢ [–∞–Ω–∞–ª–∏–∑ –ø—Ä–∏—á–∏–Ω]

üîÑ –ö–ê–ö –ê–î–ê–ü–¢–ò–†–û–í–ê–¢–¨–°–Ø:
‚Ä¢ [—Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=600,
                temperature=0.7
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –ø–∞–¥–∞—é—â–∏—Ö —Ç—Ä–µ–Ω–¥–æ–≤: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."

    async def analyze_trending_channels(self, category: str) -> str:
        """V2: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ç—Ä–µ–Ω–¥–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç—Ä–µ–Ω–¥–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–∞—Ö
            channels_data = await data_analyzer.get_trending_channels(category, days=7)
            
            context = ""
            if channels_data:
                context += f"\n–¢—Ä–µ–Ω–¥–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã –≤ '{category}':\n"
                for channel in channels_data[:3]:
                    context += f"‚Ä¢ {channel.get('title', '–ù/–î')} - {channel.get('subscribers', 0):,} –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤\n"
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∞–Ω–∞–ª–∏–∑—É Telegram-–∫–∞–Ω–∞–ª–æ–≤. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ç—Ä–µ–Ω–¥–æ–≤—ã–µ –∫–∞–Ω–∞–ª—ã –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{category}".

–ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–°–æ–∑–¥–∞–π –∞–Ω–∞–ª–∏–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

üî• –¢–†–ï–ù–î–û–í–´–ï –ö–ê–ù–ê–õ–´ (V2)

üìä –¢–û–ü –ö–ê–ù–ê–õ–û–í:
‚Ä¢ [–∞–Ω–∞–ª–∏–∑ –ª—É—á—à–∏—Ö –∫–∞–Ω–∞–ª–æ–≤]

üéØ –°–ï–ö–†–ï–¢–´ –£–°–ü–ï–•–ê:
‚Ä¢ [—á—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–∏ –∫–∞–Ω–∞–ª—ã —É—Å–ø–µ—à–Ω—ã–º–∏]

üí° –ß–¢–û –ú–û–ñ–ù–û –ü–ï–†–ï–ù–Ø–¢–¨:
‚Ä¢ [–∏–¥–µ–∏ –¥–ª—è —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –∫–∞–Ω–∞–ª–∞]

üìà –¢–†–ï–ù–î–´ –í –ö–ê–¢–ï–ì–û–†–ò–ò:
‚Ä¢ [–æ–±—â–∏–µ —Ç—Ä–µ–Ω–¥—ã —Å—Ä–µ–¥–∏ –∫–∞–Ω–∞–ª–æ–≤]

üöÄ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
‚Ä¢ [–∫–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–Ω—ã–µ –∑–Ω–∞–Ω–∏—è]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=700,
                temperature=0.8
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤—ã—Ö –∫–∞–Ω–∞–ª–æ–≤: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."

    async def analyze_best_times(self, category: str) -> str:
        """V2: –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –ª—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π"""
        try:
            # –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–Ω–æ –¢–ó
            if not self.validate_input(category):
                return json.dumps({
                    "status": "error",
                    "message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.",
                    "show_categories": True
                }, ensure_ascii=False)
            
            # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ª—É—á—à–µ–º –≤—Ä–µ–º–µ–Ω–∏
            times_data = await data_analyzer.get_best_posting_times(category)
            
            context = ""
            if times_data:
                best_hours = times_data.get('best_hours', [])
                best_days = times_data.get('best_days', [])
                if best_hours:
                    context += f"\n–õ—É—á—à–∏–µ —á–∞—Å—ã –≤ '{category}':\n"
                    for hour in best_hours:
                        context += f"‚Ä¢ {hour.get('hour', 0)}:00 - ER: {hour.get('avg_er', 0):.1f}%\n"
                if best_days:
                    context += f"\n–õ—É—á—à–∏–µ –¥–Ω–∏ –≤ '{category}':\n"
                    for day in best_days:
                        context += f"‚Ä¢ {day.get('day', '–ù/–î')} - ER: {day.get('avg_er', 0):.1f}%\n"
            
            prompt = f"""–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ —Ç–∞–π–º–∏–Ω–≥—É –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ Telegram. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –ª—É—á—à–µ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "{category}".

–ï—Å–ª–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ—Å–º—ã—Å–ª–µ–Ω–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞, —è–≤–ª—è–µ—Ç—Å—è –±–µ—Å—Å–º—ã—Å–ª–µ–Ω–Ω—ã–º –Ω–∞–±–æ—Ä–æ–º —Å–∏–º–≤–æ–ª–æ–≤, –∞–±—Ä–∞–∫–∞–¥–∞–±—Ä–æ–π –∏–ª–∏ –Ω–µ –ø–æ–¥–¥–∞–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–∏, –æ—Ç–ø—Ä–∞–≤—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π JSON:

{{
"status": "error",
"message": "–ó–∞–ø—Ä–æ—Å –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ.", "show_categories": true
}}

–ö–æ–Ω—Ç–µ–∫—Å—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:{context}

–°–æ–∑–¥–∞–π –∞–Ω–∞–ª–∏–∑ –≤ —Ñ–æ—Ä–º–∞—Ç–µ:

‚è∞ –õ–£–ß–®–ï–ï –í–†–ï–ú–Ø –î–õ–Ø –ü–£–ë–õ–ò–ö–ê–¶–ò–ô (V2)

üìÖ –ü–û –î–ù–Ø–ú –ù–ï–î–ï–õ–ò:
‚Ä¢ [–∞–Ω–∞–ª–∏–∑ –ø–æ –¥–Ω—è–º –Ω–µ–¥–µ–ª–∏]

üïê –ü–û –ß–ê–°–ê–ú:
‚Ä¢ [–∞–Ω–∞–ª–∏–∑ –ø–æ —á–∞—Å–∞–º]

üìä –û–°–û–ë–ï–ù–ù–û–°–¢–ò –ê–£–î–ò–¢–û–†–ò–ò:
‚Ä¢ [–ø–æ–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏—Ç–æ—Ä–∏–∏]

üéØ –ö–û–ù–ö–†–ï–¢–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
‚Ä¢ [—Ç–æ—á–Ω–æ–µ –≤—Ä–µ–º—è –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–π]

üí° –°–û–í–ï–¢–´ –ü–û –¢–ê–ô–ú–ò–ù–ì–£:
‚Ä¢ [–¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏]"""

            response = await asyncio.to_thread(
                self.client.chat.completions.create,
                model="gpt-4",
                messages=[{"role": "user", "content": prompt}],
                max_tokens=600,
                temperature=0.7
            )
            
            return response.choices[0].message.content
        except Exception as e:
            return f"‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ –≤—Ä–µ–º–µ–Ω–∏ –ø—É–±–ª–∏–∫–∞—Ü–∏–π: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É."

# –ì–ª–æ–±–∞–ª—å–Ω—ã–π —ç–∫–∑–µ–º–ø–ª—è—Ä GPT —Å–µ—Ä–≤–∏—Å–∞
gpt_service = GPTService() 